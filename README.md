# 温知数据备份系统

## 项目介绍

帮助笔记类工具快速建立自己的数据备份功能，给用户数据提供一个安全保障，提升软件的稳定性和安全性，降低用户数据同步成本，提高数据同步速度。

## 功能列表
- [x] 文件备份
- [x] 数据备份
- [x] 数据加密
- [x] 数据同步
- [x] 增量同步
- [x] webdav 支持
- [x] s3 支持
- [ ] ftp/sftp 支持

## 数据类型
- 数据集
- 文件

## 相关问题

### 如何实现增量同步？

问题描述：客户端对数据实现增量同步，减少每次数据同步的传输数据量。

解决方案：
1. 客户端对每次编辑更新的数据进行记录，形成数据记录
2. 将数据记录写到数据块，每100kb一个数据块，每个数据块都有一个uuid
3. 将数据库按照创建日期进行分组上传，上传到服务器路径：[config_path]/backup/[date]/[hour]/[uuid].zip
4. 生成文件md5信息，上传到服务器路径：[config_path]/backup/[date]/[hour]/[uuid].md5
5. 客户端刷新数据时，查询当前时间hour和前一小时的数据块md5信息，对比本地数据块md5信息，找出需要下载的数据块
6. 客户端下载数据后，记录数据块的md5信息，用于下次对比查询增量数据块


### 增量同步关键点是什么？

1. 通过文件的md5信息，可以快速找到需要下载的数据块，从而实现增量同步。
2. 数据按照时间进行分组，每小时只需要同步查询部分数据，减少每次同步数据量。
3. 数据块设计，每100kb一个数据块，减少了文件产生数量，提升数据同步速度。

### 为啥数据块是 100kb？

- 100kb是一个经验值，可以根据实际情况进行修改。
- 每次编辑笔记并且保存后，笔记一般大小为1kb左右，100kb可以存储100条笔记。
- 网络宽带如果为1mbps(需要除以8)，传输100kb数据只需要1秒。
- 每小时3600秒，每20秒编辑保存一次，则会产生180个数据记录，也就产生了2个数据块而已。
- 每1秒同步一次的话，数据量可控，也就相当于1张jpg图片头像的数据量。
- 如果没有编辑数据，最多也就4个md5文件查询，数据量不到1kb。
- 服务商会根据文件最小64kb进行存储计费，为了减少存储费用，数据块要大于64kb。

### 何时查询备份数据？

1. 列表刷新时，会查询最近2小时数据
2. 客户端启动/手动触发，会启动一次近2日数据同步
3. 客户端首次启动/手动触发，会进行一次全量同步

### 何时上传备份数据？

1. 用户编辑更新数据后，将数据记录写到数据备份系统
2. 数据备份系统会根据当前数据块长度判断是否创建新的数据块
3. 数据备份系统将记录写到数据块
4. 数据备份系统将数据块上传到hour文件夹

### 如何加速数据全量查询？

方案一： 服务器可以提供接口，或者自动化任务，实现对数据压缩，将每天数据压缩到日期下的all.zip文件，减少数据查询次数。

方案二： 服务器支持文件夹递归查询，减少数据查询次数。

方案三： 服务器支持增量写入，客户端每次更新都会在增量文件增加数据：uuid|64位时间戳|文件md5，客户端根据这个文件查询缺失的数据块文件。